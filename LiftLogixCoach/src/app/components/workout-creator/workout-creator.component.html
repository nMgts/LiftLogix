<div class="not-expanded-box" *ngIf="!isBoxExpanded">
  <h1 class="header" *ngIf="window.innerWidth > 650">Kreator planów</h1>
  <div class="content">
    <img ngSrc="/icons/workout.png" alt="Workout creator Icon" class="workout-creator-image" width="136" height="136"/>
  </div>
</div>

<div class="expanded-box" *ngIf="isBoxExpanded" (click)="cancelAllActions()">
  <button (click)="close($event)" class="close-button">&times;</button>
  <h1 class="creator-header">Stwórz plan</h1>

  <div *ngIf="showAdvancedOptions" class="micro-meso-info">Mezocykl: {{ getMesocycleIndex() + 1 }}, Mikrocykl: {{ getMicrocycleIndex() + 1 }}</div>

  <div class="workout-name-container">
    <input [(ngModel)]="selectedWorkout.name" readonly/>
    <button class="dropdown-button" (click)="toggleDropdown($event)">
      <mat-icon>expand_more</mat-icon>
    </button>
    <button class="add-button" (click)="createNewWorkout()">
      <mat-icon>add</mat-icon>
      <span>Dodaj jednostkę treningową</span>
    </button>
    <div *ngIf="showDropdown" class="dropdown-menu">
      <div class="dropdown-item" *ngFor="let workout of selectedMicrocycle.workouts" (click)="selectWorkout(workout)">
        <span (click)="selectWorkout(workout)">{{ workout.name }}</span>
        <mat-icon (click)="removeWorkout(workout, $event)">delete</mat-icon>
      </div>
    </div>
  </div>

  <div class="advanced-options-checkbox">
    <label>
      <input type="checkbox" [(ngModel)]="showAdvancedOptions"/>
      Opcje zaawansowane
    </label>
  </div>

  <table class="exercise-table" [ngClass]="{'advanced-options': showAdvancedOptions, 'basic-options': !showAdvancedOptions}">
    <thead>
    <tr>
      <th>Ćwiczenie</th>
      <th>Ilość serii</th>
      <th>Powtórzenia</th>
      <th>Ciężar</th>
      <th *ngIf="showAdvancedOptions">%1RM</th>
      <th class="tempo-tooltip" *ngIf="showAdvancedOptions">
        Tempo
        <mat-icon>info</mat-icon>
        <span class="tooltip-text">
          Tempo musi być w formacie 1-1-1-1. Oprócz cyfry można zastosować znak x, oznacza on "jak najszybciej". Jednostką są sekundy.
          Pierwsza pozycja to ekscentryka,
          druga to pauza,
          trzecia to koncentryka,
          czwarta to pauza.
          Można również pozostawić puste.
        </span>
      </th>
      <th *ngIf="showAdvancedOptions">RPE</th>
      <th *ngIf="showAdvancedOptions">Przerwa</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let exercise of selectedWorkout.workoutExercises">
      <td (click)="openEditExerciseNameDialog(exercise)">
        {{ exercise.exercise.name }}
        <mat-icon class="info-icon" (click)="openExerciseDetails(exercise.exercise, $event)">info</mat-icon>
      </td>
      <td (click)="editCell(exercise, 'series')">
        <ng-container *ngIf="!isEditing(exercise, 'series'); else editSeries">
          {{ exercise.series || '' }}
        </ng-container>
        <ng-template #editSeries>
          <input #inputElement type="number" [(ngModel)]="exercise.series" (blur)="endEdit(exercise, 'series')" (keydown.enter)="endEdit(exercise, 'series')" />
        </ng-template>
      </td>
      <td class="repetitions-cell" (click)="editCell(exercise, 'repetitions')">
        <ng-container *ngIf="!isEditing(exercise, 'repetitions'); else editRepetitions">
          {{ formatRepetitions(exercise) }}
        </ng-container>
        <ng-template #editRepetitions>
          <div class="repetitions-inputs">
            <input type="number" [(ngModel)]="exercise.repetitionsFrom" (blur)="endEdit(exercise, 'repetitions')" (keydown.enter)="endEdit(exercise, 'repetitions')" placeholder="od" />
             -
            <input type="number" [(ngModel)]="exercise.repetitionsTo" (blur)="endEdit(exercise, 'repetitions')" (keydown.enter)="endEdit(exercise, 'repetitions')" placeholder="do" />
          </div>
        </ng-template>
      </td>
      <td (click)="editCell(exercise, 'weight')">
        <ng-container *ngIf="!isEditing(exercise, 'weight'); else editWeight">
          {{ exercise.weight ? exercise.weight + 'kg' : '' }}
        </ng-container>
        <ng-template #editWeight>
          <input #inputElement type="number" [(ngModel)]="exercise.weight" (blur)="endEdit(exercise, 'weight')" (keydown.enter)="endEdit(exercise, 'weight')" />
        </ng-template>
      </td>
      <td *ngIf="showAdvancedOptions" (click)="editCell(exercise, 'percentage')">
        <ng-container *ngIf="!isEditing(exercise, 'percentage'); else editPercentage">
          {{ exercise.percentage ? exercise.percentage + '%' : '' }}
        </ng-container>
        <ng-template #editPercentage>
          <input #inputElement type="number" [(ngModel)]="exercise.percentage" (blur)="endEdit(exercise, 'percentage')" (keydown.enter)="endEdit(exercise, 'percentage')" />
        </ng-template>
      </td>
      <td *ngIf="showAdvancedOptions" (click)="editCell(exercise, 'tempo')">
        <ng-container *ngIf="!isEditing(exercise, 'tempo'); else editTempo">
          {{ exercise.tempo || '' }}
        </ng-container>
      <ng-template #editTempo>
        <input #inputElement [(ngModel)]="exercise.tempo" (blur)="endEdit(exercise, 'tempo')"
               (keydown.enter)="endEdit(exercise, 'name')" (input)="onTempoInput($event, exercise)"
               placeholder="1-1-1-1"/>
      </ng-template>
      </td>
      <td *ngIf="showAdvancedOptions" (click)="editCell(exercise, 'rpe')">
        <ng-container *ngIf="!isEditing(exercise, 'rpe'); else editRpe">
          {{ exercise.rpe || '' }}
        </ng-container>
        <ng-template #editRpe>
          <input #inputElement type="number" min="1" max="10" [(ngModel)]="exercise.rpe" (blur)="validateRpe(exercise)" (keydown.enter)="endEdit(exercise, 'rpe')" />
        </ng-template>
      </td>
      <td *ngIf="showAdvancedOptions" class="break-cell" (click)="editCell(exercise, 'break')">
        <ng-container *ngIf="!isEditing(exercise, 'break'); else editBreak">
          {{ exercise.break.value ? exercise.break.value + exercise.break.unit : '' }}
        </ng-container>
        <ng-template #editBreak>
          <div class="break-input">
            <input type="number" [(ngModel)]="exercise.break.value" (blur)="endEdit(exercise, 'break')" (keydown.enter)="endEdit(exercise, 'break')" />
            <select [(ngModel)]="exercise.break.unit" (blur)="endEdit(exercise, 'break')">
              <option value="s">s</option>
              <option value="min">min</option>
            </select>
          </div>
        </ng-template>
      </td>
      <td>
        <mat-icon class="delete-icon" (click)="removeExercise(exercise)">delete</mat-icon>
      </td>
    </tr>
    </tbody>
  </table>

  <button class="add-exercise-button" (click)="openAddExerciseDialog()">
    <mat-icon>add</mat-icon>
    <span>Dodaj ćwiczenie</span>
  </button>

  <button (click)="duplicateWorkout()" mat-raised-button color="primary">Duplikuj trening</button>

  <!-- Microcycle -->

  <div class="microcycle-length-form">
    <label for="microcycle-length">Długość mikrocyklu (dni):</label>
    <input type="number" id="microcycle-length" [(ngModel)]="microcycleLength" (input)="setMicrocycleLength(microcycleLength)" />
  </div>

  <div class="meso-macro-inputs" *ngIf="showAdvancedOptions">
    <label>
      <input type="checkbox" [(ngModel)]="showMesocycle"/>
      Stwórz mezocykl
    </label>
    <label *ngIf="showMesocycle">
      <input type="checkbox" [(ngModel)]="showMacrocycle"/>
      Stwórz makrocykl
    </label>
  </div>

  <div class="microcycle-table">
    <h1>Mikrocykl</h1>
    <table>
      <thead>
      <tr>
        <th *ngFor="let day of daysInWeek">{{ day }}</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let row of microcycleTable">
        <td *ngFor="let cell of row" [ngClass]="{'hidden-cell': cell === 0, 'active-cell': cell !== 0}">
          <div class="cell-content" *ngIf="cell !== 0">

            <div class="workout-name">
              <span *ngFor="let workout of getWorkoutsForDay(cell)" class="workout-letter" (click)="removeWorkoutFromMicrocycle(workout, cell)">
                {{ getWorkoutInitials(workout.name) }}
              </span>
              <span class="plus-icon" (click)="toggleMicrocycleCellDropdown($event, cell)">+</span>
            </div>

            <div class="microcycle-cell-dropdown-menu" *ngIf="microcycleCellDropdownVisible && activeCell === cell">
              <ul>
                <li *ngFor="let workout of selectedMicrocycle.workouts" (click)="addWorkoutToMicrocycle(workout, cell)">{{ workout.name }}</li>
              </ul>
            </div>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="microcycle-count-form" *ngIf="showMesocycle">
    <label for="microcycle-count">Ilość mikrocykli:</label>
    <input type="number" id="microcycle-count" [(ngModel)]="microcycleCount" (input)="setMicrocycleCount(microcycleCount)" min="1" />
  </div>

  <div class="mesocycle-table" *ngIf="showMesocycle">
    <h1>Mezocykl</h1>
    <table>
      <thead>
      <tr>
        <th *ngFor="let microcycle of selectedMesocycle.microcycles; let i = index" [ngClass]="{'highlighted-header': microcycle == selectedMicrocycle}">
          <div class="microcycle-header">
            <span class="microcycle-thead">
              {{ toRoman(i + 1) }}
            </span>
            <div class="microcycle-management">
              <mat-icon (click)="selectMicrocycle(i)">edit</mat-icon>
              <mat-icon (click)="deleteMicrocycle(i)">delete</mat-icon>
            </div>
          </div>
        </th>
      </tr>
      </thead>
    </table>
  </div>

  <div class="mesocycle-count-form" *ngIf="showMesocycle">
    <label for="mesocycle-count">Ilość mikrocykli:</label>
    <input type="number" id="mesocycle-count" [(ngModel)]="mesocycleCount" (input)="setMesocycleCount(mesocycleCount)" min="1" />
  </div>

  <div class="macrocycle-table" *ngIf="showMesocycle && showMacrocycle">
    <h1>Makrocykl</h1>
    <table>
      <thead>
      <tr>
        <th *ngFor="let mesocycle of macrocycle.mesocycles; let i = index" [ngClass]="{'highlighted-header': mesocycle == selectedMesocycle}">
          <div class="mesocycle-header">
            <span class="mesocycle-thead">
              {{ toRoman(i + 1) }}
            </span>
            <div class="mesocycle-management">
              <mat-icon (click)="selectMesocycle(i)">edit</mat-icon>
              <mat-icon (click)="deleteMesocycle(i)">delete</mat-icon>
            </div>
          </div>
        </th>
      </tr>
      </thead>
    </table>
  </div>
</div>
